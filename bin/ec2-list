#!/bin/bash -e

DESCRIBE_FILE=/tmp/ec2_describe.out
CODE_RUNNING=16

usage() {
  echo "Usage: ec2 list [ -r ] [ PATTERN ]"
}

running=0

while getopts "hr" opt; do
    case $opt in
      h)
        usage
        exit 0
        ;;
      r)
        running=1
        shift
        ;;
      \?)
        usage
        exit 1
        ;;
    esac
done

if [ $# == 0 ]; then 
  PATTERN=".*"
else
  PATTERN=$1
fi

DESCRIBE_CMD=ec2-describe-instances
if [ "$running" == "1" ]; then
   DESCRIBE_CMD="$DESCRIBE_CMD --filter instance-state-code=$CODE_RUNNING"
fi

$DESCRIBE_CMD > $DESCRIBE_FILE
awk '/^TAG.*Name\t'"$PATTERN"'$/ { print $3, $5 }' $DESCRIBE_FILE
